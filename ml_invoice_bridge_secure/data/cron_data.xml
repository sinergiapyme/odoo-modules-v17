<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <record id="cron_auto_upload_ml_invoices" model="ir.cron">
            <field name="name">Auto Upload ML Invoices</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="state">code</field>
            <field name="code">
import time
from datetime import datetime, timedelta

config = env['mercadolibre.config'].get_active_config()

if not config:
    env['mercadolibre.log'].create({
        'invoice_id': False,
        'status': 'error', 
        'message': 'Cron stopped: No active MercadoLibre configuration found',
        'ml_pack_id': False
    })
    raise Exception("No active ML config")

if not config.auto_upload:
    env['mercadolibre.log'].create({
        'invoice_id': False,
        'status': 'error',
        'message': 'Cron stopped: Auto upload disabled in MercadoLibre config',
        'ml_pack_id': False  
    })
    raise Exception("Auto upload disabled")

recent_errors = env['mercadolibre.log'].search([
    ('status', '=', 'error'),
    ('create_date', '&gt;=', datetime.now() - timedelta(hours=1)),
    ('message', 'ilike', 'cron')
], count=True)

if recent_errors >= 5:
    env['mercadolibre.log'].create({
        'invoice_id': False,
        'status': 'error',
        'message': 'Cron stopped: Circuit breaker activated',
        'ml_pack_id': False
    })
    raise Exception("Circuit breaker activated")

pending_invoices = env['account.move'].search([
    ('is_ml_sale', '=', True),
    ('ml_uploaded', '=', False),
    ('state', '=', 'posted'),
    ('ml_pack_id', '!=', False),
    ('ml_pack_id', '!=', ''),
], limit=2)

env['mercadolibre.log'].create({
    'invoice_id': False,
    'status': 'success',
    'message': 'Cron execution started',
    'ml_pack_id': False
})

success_count = 0
error_count = 0

for invoice in pending_invoices:
    try:
        if success_count > 0:
            time.sleep(5)
        
        if not invoice.ml_pack_id or not invoice.is_ml_sale or invoice.state != 'posted':
            error_count += 1
            continue
        
        result = invoice.action_upload_to_mercadolibre()
        success_count += 1
        
        env['mercadolibre.log'].create_log(
            invoice_id=invoice.id,
            status='success',
            message='Cron auto upload successful',
            ml_pack_id=invoice.ml_pack_id
        )
        
    except Exception as e:
        error_count += 1
        env['mercadolibre.log'].create_log(
            invoice_id=invoice.id,
            status='error',
            message='Cron auto upload failed',
            ml_pack_id=invoice.ml_pack_id or 'N/A'
        )
        
        if error_count >= 2:
            break

env['mercadolibre.log'].create({
    'invoice_id': False,
    'status': 'success' if error_count == 0 else 'error',
    'message': 'Cron execution completed',
    'ml_pack_id': False
})
            </field>
            <field name="interval_number">30</field>
            <field name="interval_type">minutes</field>
            <field name="numbercall">-1</field>
            <field name="active">False</field>
            <field name="user_id" ref="base.user_root"/>
            <field name="priority">10</field>
        </record>

        <record id="cron_fix_ml_data_invoices" model="ir.cron">
            <field name="name">Fix Missing ML Data in Invoices</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="state">code</field>
            <field name="code">
from datetime import datetime, timedelta

try:
    recent_date = datetime.now() - timedelta(days=7)
    
    invoices_to_fix = env['account.move'].search([
        ('create_date', '&gt;=', recent_date),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', '!=', 'cancel'),
        ('is_ml_sale', '=', False),
        ('invoice_origin', '!=', False),
        '|', '|', '|',
        ('invoice_origin', 'ilike', 'mercadolibre'),
        ('invoice_origin', 'ilike', 'mercado libre'),
        ('invoice_origin', 'ilike', 'ml order'),
        ('invoice_origin', 'ilike', 'ml_'),
    ], limit=10)
    
    fixed_count = 0
    for invoice in invoices_to_fix:
        try:
            ml_data = invoice._auto_detect_ml_from_origin_and_lines()
            if ml_data.get('is_ml_sale'):
                invoice.write(ml_data)
                fixed_count += 1
                
        except Exception:
            continue
    
    env['mercadolibre.log'].create({
        'invoice_id': False,
        'status': 'success',
        'message': 'ML data fix cron completed',
        'ml_pack_id': False
    })
    
except Exception:
    env['mercadolibre.log'].create({
        'invoice_id': False,
        'status': 'error',
        'message': 'Error in ML data fix cron',
        'ml_pack_id': False
    })
            </field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="active">False</field>
            <field name="user_id" ref="base.user_root"/>
            <field name="priority">15</field>
        </record>

    </data>
</odoo>
